<!--
 * @Author: LetMeFly
 * @Date: 2025-02-08 17:09:53
 * @LastEditors: LetMeFly.xyz
 * @LastEditTime: 2025-02-11 13:50:34
-->
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>æ¡ˆä¾‹ - {{ fileName }}</title>
    <script src="https://letmefly.xyz/Links/Common.js" async></script>
    <script src="/static/js/marked.min.js"></script>
    <style>
        .forbidden {
            display: none;
        }

        details[open] {
            border: 1px solid #ccc;
            /* è¾¹æ¡†æ ·å¼ */
            border-radius: 4px;
            /* åœ†è§’æ•ˆæœ */
            padding: 10px;
            /* å†…è¾¹è· */
            margin: 5px 0;
            /* å¤–è¾¹è· */
        }

        /* å¯é€‰ï¼šè‡ªå®šä¹‰summaryçš„æ ·å¼ */
        summary {
            cursor: pointer;
            padding: 4px;
            list-style: none;
            /* å»é™¤é»˜è®¤ä¸‰è§’ç¬¦å· */
        }

        /* è‡ªå®šä¹‰ä¸‰è§’å›¾æ ‡ */
        summary::marker {
            display: none;
        }

        summary::before {
            content: "ğŸ‘‰";
            /* é—­åˆæ—¶æ˜¾ç¤ºğŸ‘‰ */
            padding-right: 6px;
        }

        details[open] summary::before {
            content: "ğŸ‘‡";
            /* å±•å¼€æ—¶æ˜¾ç¤ºğŸ‘‡ */
        }

        .thinkTag {
            color: gray;
            border-left: #ccc solid 1px;
            padding-left: 10px;
        }

        .thinkTag::before {
            content: 'ğŸ’­æ€è€ƒå†…å®¹';
            margin-left: -15px;
        }
    </style>
</head>

<body>
    <div name="header">
        <button id="backToMainPage">å›åˆ°ä¸»é¡µ</button>
        <h3>æ¡ˆä¾‹åç§°ï¼š{{ fileName }}</h3>
        <div class="status-tags">
            <span class="badge">åˆ†æé˜¶æ®µï¼š{{ progress_now }}</span>
        </div>
    </div>

    <div id="progress">
        <div id="progress-1">
            <h3>æ­¥éª¤1ï¼šä¸Šä¼ æ¡ˆä¾‹æ–‡ä»¶(<span name="state"></span>)</h3>
            <div name="option"></div>
        </div>
        <div id="progress-2">
            <h3>æ­¥éª¤2ï¼šDSåˆæ­¥åˆ†æ(<span name="state"></span>)</h3>
            <div name="option">
                <button id="progress-2-start">å¼€å§‹åˆ†æ</button>
            </div>
            <details name="log" id="log2">
                <summary>æ­¥éª¤æ—¥å¿—</summary>
                <div name="log-content">
                    <div class="output forbidden" id="output2"></div>
                    <div class="markdown" id="markdown2"></div>
                </div>
            </details>
        </div>
        <div id="progress-3">
            <h3>æ­¥éª¤3ï¼šç»™DSå†³ç­–æ ‘å¹¶è®©å®ƒå†æ¬¡åˆ†æ(<span name="state"></span>)</h3>
            <div name="option"></div>
        </div>
        <div id="progress-4">
            <h3>æ­¥éª¤4ï¼šçº æ­£DSé”™è¯¯(<span name="state"></span>)</h3>
            <div name="option"></div>
        </div>
        <div id="progress-5">
            <h3>æ­¥éª¤5ï¼šé”™è¯¯çº æ­£å¯¹è¯(<span name="state"></span>)</h3>
            <div name="option"></div>
        </div>
        <div id="progress-6">
            <h3>æ­¥éª¤6ï¼šç”Ÿæˆä½¿ç”¨å†³ç­–æ ‘å‰åçš„ç»“æœå¯¹æ¯”è¡¨(<span name="state"></span>)</h3>
            <div name="option"></div>
        </div>
    </div>
    <script name="showLogs">
        function showLog1() {
            // Nothing to do
        }

        let eventSource2;
        let alreadyEnd = true;  // é˜²æ­¢æœ¬æ¥å°±å¯¹è¯ç»“æŸå¯¼è‡´çš„é‡å¤æ¸²æŸ“
        function showLog2() {
            if (eventSource2) {
                eventSource2.close();
            }
            const eventSource = new EventSource(`/chatData/${caseHash}`);
            eventSource2 = eventSource;
            const output = document.querySelector('#progress-2 [name=log] .output');
            var responseText = '';
            eventSource.onmessage = () => {
                const data = JSON.parse(event.data);
                responseText += data['content'];
                output.innerHTML = responseText;
                if (data['code'] == 1) {  // ç»“æŸ
                    eventSource.close();
                    if (!alreadyEnd) {
                        alert('å¯¹è¯ç»“æŸ');
                        renderProgress();  // é‡æ–°æ¸²æŸ“å¯¹è¯çŠ¶æ€
                    }
                    return;
                }
                if (data['code'] == 2) {  // å¯¹è¯ä¸å­˜åœ¨
                    eventSource.close();
                    console.log('å¯¹è¯ä¸å­˜åœ¨ï¼');
                } else {
                    alreadyEnd = false;
                }
            };
            eventSource.onerror = (err) => {
                console.log('è¿æ¥é”™è¯¯ï¼', err);
                eventSource.close();
            }
        }

        function showLog3() {

        }

        function showLog4() {

        }

        function showLog5() {

        }

    </script>

    <script>
        const caseHash = '{{ caseHash }}';
        const stepList = [
            'ä¸Šä¼ æ¡ˆä¾‹æ–‡ä»¶',                 // 1
            'DSåˆæ­¥åˆ†æ',                   // 2
            'ç»™DSå†³ç­–æ ‘å¹¶è®©å®ƒå†æ¬¡åˆ†æ',      // 3
            'çº æ­£DSé”™è¯¯',                   // 4
            'ç”Ÿæˆä½¿ç”¨å†³ç­–æ ‘å‰åçš„ç»“æœå¯¹æ¯”è¡¨'  // 5
        ];
        const showLogFunctions = [
            showLog1,  // step1
            showLog2,  // step2
            showLog3,  // step3
            showLog4,  // step4
            showLog5,  // step5
        ];
        const nowStep = '{{ progress_now }}';

        function renderProgress() {
            const progressDiv = document.getElementById('progress');
            var finished = true;
            for (var step = 1; step <= stepList.length; step++) {
                const stepDiv = document.getElementById('progress-' + step);
                const optionDiv = stepDiv.querySelector('[name=option]');
                const statusSpan = stepDiv.querySelector('[name=state]');
                const logDetails = stepDiv.querySelector('[name=log]');
                if (finished) {
                    statusSpan.innerHTML = 'å·²å®Œæˆ';
                    optionDiv.classList.add('forbidden');
                    showLogFunctions[step - 1]();
                    if (nowStep === stepList[step - 1]) {  // åˆšå¥½å®Œæˆåˆ°è¿™ä¸€æ­¥
                        finished = false;
                    }
                } else {
                    if (nowStep === stepList[step - 2]) {  // åº”è¯¥æˆ–è€…æ­£åœ¨å®Œæˆè¿™ä¸€æ­¥
                        statusSpan.innerHTML = 'è¿›è¡Œåˆ°';
                        optionDiv.classList.remove('forbidden');
                        showLogFunctions[step - 1]();
                    } else {
                        statusSpan.innerHTML = 'æœªå¼€å§‹';
                        optionDiv.classList.add('forbidden');
                        logDetails && logDetails.classList.add('forbidden');
                    }
                }
            }
        }

        renderProgress();
    </script>

    <script name="option">
        document.querySelector('#backToMainPage').onclick = () => {
            window.location.href = '/';
        };

        const progress_2_start = document.querySelector('#progress-2-start');
        progress_2_start.onclick = async () => {
            // progress_2_start.disabled = true;
            document.querySelector('#log2').setAttribute('open', '');
            fetch(`/chatStart/${caseHash}`, {
                method: 'POST',
            }).then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error(`è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : ${response.status}`);
                }
            }).then(result => {
                console.log(result);
                alert(result['msg']);
                showLog2();
            }).catch(error => {
                alert('è¯·æ±‚å¤±è´¥' + error);
            });
        };
    </script>

    <script name="markdownRender">
        // é…ç½®è§‚å¯Ÿé€‰é¡¹
        const config = {
            childList: true, // è§‚å¯Ÿå­èŠ‚ç‚¹çš„å˜åŒ–
            subtree: true,   // è§‚å¯Ÿæ‰€æœ‰åä»£èŠ‚ç‚¹
            characterData: true // è§‚å¯Ÿæ–‡æœ¬å†…å®¹çš„å˜åŒ–
        };

        // markdownæ¸²æŸ“2 - è¿™é‡Œå…ˆå †ç‚¹shiShanä»£ç å¥½äº†
        const output2 = document.getElementById('output2');
        const markdown2 = document.getElementById('markdown2');
        function renderMarkdown2() {
            const inputText = output2.innerHTML;
            const renderedHtml = marked.parse(inputText);
            markdown2.innerHTML = renderedHtml;
        }
        // åˆ›å»ºä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå½“è§‚å¯Ÿåˆ°å˜åŒ–æ—¶æ‰§è¡Œ
        const onOutputModified2 = function (mutationsList, observer) {
            for (let mutation of mutationsList) {
                if (mutation.type === 'childList' || mutation.type === 'characterData') {
                    // è°ƒç”¨ renderMarkdown å‡½æ•°
                    renderMarkdown2();
                }
            }
        };
        // åˆ›å»ºä¸€ä¸ª MutationObserver å®ä¾‹å¹¶ä¼ å…¥å›è°ƒå‡½æ•°
        const observer2 = new MutationObserver(onOutputModified2);
        // å¼€å§‹è§‚å¯Ÿç›®æ ‡èŠ‚ç‚¹
        observer2.observe(output2, config);

    </script>

    <script>
        // // ä½¿ç”¨EventSourceæ¥æ”¶æµå¼æ•°æ®
        // const eventSource = new EventSource(`/stream/${caseId}`);

        // eventSource.onmessage = (event) => {
        //     const data = JSON.parse(event.data);
        //     if (data.type === 'status_update') {
        //         updateProgress(data);
        //     } else {
        //         appendMessage(data);
        //     }
        // };

        // function appendMessage(data) {
        //     const messageDiv = document.createElement('div');
        //     messageDiv.className = `message ${data.role}-message`;
        //     messageDiv.innerHTML = `
        //         <div class="message-header">${data.sender}</div>
        //         <div class="message-content">${data.content}</div>
        //     `;
        //     chatMessages.appendChild(messageDiv);
        //     chatMessages.scrollTop = chatMessages.scrollHeight;
        // }
    </script>
</body>

</html>