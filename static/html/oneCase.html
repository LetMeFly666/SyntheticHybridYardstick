<!--
 * @Author: LetMeFly
 * @Date: 2025-02-08 17:09:53
 * @LastEditors: LetMeFly.xyz
 * @LastEditTime: 2025-02-08 22:00:22
-->
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>案例 - {{ fileName }}</title>
    <script src="https://letmefly.xyz/Links/Common.js" async></script>
    <style>
        .forbidden {
            display: none;
        }
    </style>
</head>

<body>
    <div name="header">
        <button id="backToMainPage">回到主页</button>
        <h3>案例名称：{{ fileName }}</h3>
        <div class="status-tags">
            <span class="badge">分析阶段：{{ progress_now }}</span>
        </div>
    </div>

    <div id="progress">
        <div id="progress-1">
            <h3>步骤1：上传案例文件</h3>
            <div name="option"></div>
            <div name="state"></div>
        </div>
        <div id="progress-2">
            <h3>步骤2：DS初步分析</h3>
            <div name="option">
                
                <button id="progress-2-start">开始分析</button>
            </div>
            <div name="state"></div>
        </div>
        <div id="progress-3">
            <h3>步骤3：给DS决策树并让它再次分析</h3>
            <div name="option"></div>
            <div name="state"></div>
        </div>
        <div id="progress-4">
            <h3>步骤4：纠正DS错误</h3>
            <div name="option"></div>
            <div name="state"></div>
        </div>
        <div id="progress-5">
            <h3>步骤5：错误纠正对话</h3>
            <div name="option"></div>
            <div name="state"></div>
        </div>
        <div id="progress-6">
            <h3>步骤6：生成使用决策树前后的结果对比表</h3>
            <div name="option"></div>
            <div name="state"></div>
        </div>
    </div>

    <script>
        const stepList = [
            '上传案例文件',                 // 1
            'DS初步分析',                   // 2
            '给DS决策树并让它再次分析',      // 3
            '纠正DS错误',                   // 4
            '错误纠正对话',                 // 5 - optional
            '生成使用决策树前后的结果对比表'  // 6
        ];
        const nowStep = '{{ progress_now }}';

        function renderProgress() {
            const progressDiv = document.getElementById('progress');
            var finished = true;
            for (var step = 1; step <= stepList.length; step++) {
                const stepDiv = document.getElementById('progress-' + step);
                const optionDiv = stepDiv.querySelector('[name=option]');
                const statusDiv = stepDiv.querySelector('[name=state]');
                if (finished) {
                    statusDiv.innerHTML = '已完成';
                    optionDiv.classList.add('forbidden');
                    if (nowStep === stepList[step - 1]) {  // 刚好完成到这一步
                        finished = false;
                    }
                } else {
                    if (nowStep === stepList[step - 2]) {  // 应该或者正在完成这一步
                        statusDiv.innerHTML = '进行到';
                        optionDiv.classList.remove('forbidden');
                    } else {
                        statusDiv.innerHTML = '未开始';
                        optionDiv.classList.add('forbidden');
                    }
                }
            }
        }

        renderProgress();

    </script>

    <script>
        document.querySelector('#backToMainPage').onclick = () => {
            window.location.href = '/';
        };

        const progress_2_start = document.querySelector('#progress-2-start');
        progress_2_start.onclick = async () => {
            progress_2_start.disabled = true;
            
        };
    </script>

    <script>
        // 使用EventSource接收流式数据
        const eventSource = new EventSource(`/stream/${caseId}`);

        eventSource.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.type === 'status_update') {
                updateProgress(data);
            } else {
                appendMessage(data);
            }
        };

        function appendMessage(data) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${data.role}-message`;
            messageDiv.innerHTML = `
                <div class="message-header">${data.sender}</div>
                <div class="message-content">${data.content}</div>
            `;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    </script>
</body>

</html>