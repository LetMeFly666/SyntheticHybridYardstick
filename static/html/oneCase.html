<!--
 * @Author: LetMeFly
 * @Date: 2025-02-08 17:09:53
 * @LastEditors: LetMeFly.xyz
 * @LastEditTime: 2025-02-11 19:48:27
-->
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>案例 - {{ fileName }}</title>
    <script src="https://letmefly.xyz/Links/Common.js" async></script>
    <script src="/static/js/marked.min.js"></script>
    <style>
        .forbidden {
            display: none;
        }

        details[open] {
            border: 1px solid #ccc;
            /* 边框样式 */
            border-radius: 4px;
            /* 圆角效果 */
            padding: 10px;
            /* 内边距 */
            margin: 5px 0;
            /* 外边距 */
        }

        /* 可选：自定义summary的样式 */
        summary {
            cursor: pointer;
            padding: 4px;
            list-style: none;
            /* 去除默认三角符号 */
        }

        /* 自定义三角图标 */
        summary::marker {
            display: none;
        }

        summary::before {
            content: "👉";
            /* 闭合时显示👉 */
            padding-right: 6px;
        }

        details[open] summary::before {
            content: "👇";
            /* 展开时显示👇 */
        }

        .thinkTag {
            color: gray;
            border-left: #ccc solid 1px;
            padding-left: 10px;
        }

        .thinkTag::before {
            content: '💭思考内容';
            margin-left: -15px;
        }

        .inputText {
            border: #ccc solid 1px;
            display: block;
        }

        .inputText::before {
            content: 'Told DeepSeek:';
            color: black;
            font-size: large;
        }
    </style>
</head>

<body>
    <div name="header">
        <button id="backToMainPage">回到主页</button>
        <h3>案例名称：{{ fileName }}</h3>
        <div class="status-tags">
            <span class="badge">分析阶段：{{ progress_now }}</span>
        </div>
    </div>

    <div id="progress">
        <div id="progress-1">
            <h3>步骤1：上传案例文件(<span name="state"></span>)</h3>
            <div name="option"></div>
        </div>
        <div id="progress-2">
            <h3>步骤2：DS初步分析(<span name="state"></span>)</h3>
            <div name="option">
                <button id="progress-2-start">开始分析</button>
            </div>
            <details name="log" id="log2">
                <summary>步骤日志</summary>
                <pre><code class="inputText">
请结合相关法律对本案进行判决
【原案例】
                </code></pre>
                <div name="log-content">
                    <div class="output forbidden" id="output2"></div>
                    <div class="markdown" id="markdown2"></div>
                </div>
            </details>
        </div>
        <div id="progress-3">
            <h3>步骤3：给DS决策树并让它再次分析(<span name="state"></span>)</h3>
            <div name="option">
                <button id="progress-3-start">开始分析</button>
            </div>
            <details name="log" id="log3">
                <summary>步骤日志</summary>
                <pre><code class="mermaid">
graph LR
    classDef startend fill:#F5EBFF,stroke:#BE8FED,stroke-width:2px
    classDef process fill:#E5F6FF,stroke:#73A6FF,stroke-width:2px
    A([是否登记结婚]):::startend -->|是| B{是否满足离婚条件?}:::process
    A -->|否| F{是否共同生活?}:::process
    B -->|否| C([不返还彩礼]):::startend
    B -->|是| E{是否共同生活?}:::process
    B -->|是| J{婚前给付是否困难?}:::process
    F -->|是| G([结合彩礼 实际使用/嫁妆情况/双方过错/当地习俗 决定是否返还彩礼]):::startend
    F -->|否| H([全部返还彩礼]):::startend
    E -->|是| I{共同生活时间是否较短}:::process
    I -->|是| K{彩礼数额是否过高}:::process
    K -->|是| G
    I -->|否| C
    K -->|否| C
    J -->|是| H
    J -->|否| C
                </code></pre>
                <pre><code class="inputText">
请根据这个决策树进行判决：
A[是否登记结婚]-->|是|B[是否满足离婚条件?];
A-->|否|F[是否共同生活?];
B -->|否|C[不返还彩礼];
B -->|是|E[是否共同生活?];
B -->|是 |[婚前给付是否困难?];
F-->|是|G[结合彩礼实际使用、嫁妆情况、双方过错、当地习俗决定是否返还彩礼];
F-->|否|H[全部返还彩礼];
E -->|是|I[共同生活时间是否较短];
I-->|是|K[彩礼数额是否过高];
K -->|是|G;
I-->|否|C;
K -->|否|C;
J-->|是|H;
J-->|否|C;</code></pre>
                <div name="log-content">
                    <div class="output forbidden" id="output3"></div>
                    <div class="markdown" id="markdown3"></div>
                </div>
            </details>
        </div>
        <div id="progress-4">
            <h3>步骤4：纠正DS错误(<span name="state"></span>)</h3>
            <div name="option"></div>
        </div>
        <div id="progress-5">
            <h3>步骤5：生成使用决策树前后的结果对比表(<span name="state"></span>)</h3>
            <div name="option"></div>
        </div>
    </div>
    <script name="showLogs">
        function showLog1() {
            // Nothing to do
        }

        let eventSource2;
        let alreadyEnd2 = true;  // 防止本来就对话结束导致的重复渲染
        let eventSource3;
        let alreadyEnd3 = true;  // 防止本来就对话结束导致的重复渲染
        function showLog_baseFor2345(eventSource2345, outputSelector, alreadyEnd, step) {
            if (eventSource2345) {
                eventSource2345.close();
            }
            const eventSource = new EventSource(`/chatData/${caseHash}/${step}`);
            eventSource2345 = eventSource;
            const output = document.querySelector(outputSelector);
            var responseText = '';
            eventSource.onmessage = () => {
                const data = JSON.parse(event.data);
                responseText += data['content'];
                output.innerHTML = responseText;
                if (data['code'] == 1) {  // 结束
                    eventSource.close();
                    if (!alreadyEnd) {
                        alert('对话结束');
                        renderProgress();  // 重新渲染对话状态
                    }
                    return;
                }
                if (data['code'] == 2) {  // 对话不存在
                    eventSource.close();
                    console.log('对话不存在！');
                } else {
                    alreadyEnd = false;
                }
            };
            eventSource.onerror = (err) => {
                console.log('连接错误！', err);
                eventSource.close();
            }
        }

        
        function showLog2() {
            showLog_baseFor2345(eventSource2, '#progress-2 [name=log] .output', alreadyEnd2, 2);
        }

        function showLog3() {
            showLog_baseFor2345(eventSource3, '#progress-3 [name=log] .output', alreadyEnd3, 3);
        }

        function showLog4() {

        }

        function showLog5() {

        }

    </script>

    <script>
        const caseHash = '{{ caseHash }}';
        const stepList = [
            '上传案例文件',                 // 1
            'DS初步分析',                   // 2
            '给DS决策树并让它再次分析',      // 3
            '纠正DS错误',                   // 4
            '生成使用决策树前后的结果对比表'  // 5
        ];
        const showLogFunctions = [
            showLog1,  // step1
            showLog2,  // step2
            showLog3,  // step3
            showLog4,  // step4
            showLog5,  // step5
        ];
        const nowStep = '{{ progress_now }}';

        function renderProgress() {
            const progressDiv = document.getElementById('progress');
            var finished = true;
            for (var step = 1; step <= stepList.length; step++) {
                const stepDiv = document.getElementById('progress-' + step);
                const optionDiv = stepDiv.querySelector('[name=option]');
                const statusSpan = stepDiv.querySelector('[name=state]');
                const logDetails = stepDiv.querySelector('[name=log]');
                if (finished) {
                    statusSpan.innerHTML = '已完成';
                    optionDiv.classList.add('forbidden');
                    showLogFunctions[step - 1]();
                    if (nowStep === stepList[step - 1]) {  // 刚好完成到这一步
                        finished = false;
                    }
                } else {
                    if (nowStep === stepList[step - 2]) {  // 应该或者正在完成这一步
                        statusSpan.innerHTML = '进行到';
                        optionDiv.classList.remove('forbidden');
                        showLogFunctions[step - 1]();
                    } else {
                        statusSpan.innerHTML = '未开始';
                        optionDiv.classList.add('forbidden');
                        logDetails && logDetails.classList.add('forbidden');
                    }
                }
            }
        }

        renderProgress();
    </script>

    <script name="option">
        document.querySelector('#backToMainPage').onclick = () => {
            window.location.href = '/';
        };

        const progress_2_start = document.querySelector('#progress-2-start');
        const progress_3_start = document.querySelector('#progress-3-start');
        async function start1chat(step) {
            // progress_2_start.disabled = true;
            document.querySelector(`#log${step}`).setAttribute('open', '');
            fetch(`/chatStart`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',  // 这个是必须的，否则flask无法解析
                },
                body: JSON.stringify({
                    'caseHash': caseHash,
                    'step': step
                }),
            }).then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error(`请求失败，状态码: ${response.status}`);
                }
            }).then(result => {
                console.log(result);
                alert(result['msg']);
                showLogFunctions[step - 1]();
            }).catch(error => {
                alert('请求失败' + error);
            });
        };

        progress_2_start.onclick = () => {start1chat(2);};
        progress_3_start.onclick = () => {start1chat(3);};
    </script>

    <script name="markdownRender">
        // 配置观察选项
        const config = {
            childList: true,     // 观察子节点的变化
            subtree: true,       // 观察所有后代节点
            characterData: true  // 观察文本内容的变化
        };

        // markdown渲染2 - 这里先堆点shiShan代码好了
        const output2 = document.getElementById('output2');
        const markdown2 = document.getElementById('markdown2');
        function renderMarkdown2() {
            const inputText = output2.innerHTML;
            const renderedHtml = marked.parse(inputText);
            markdown2.innerHTML = renderedHtml;
        }
        // 创建一个回调函数，当观察到变化时执行
        const onOutputModified2 = function (mutationsList, observer) {
            for (let mutation of mutationsList) {
                if (mutation.type === 'childList' || mutation.type === 'characterData') {
                    // 调用 renderMarkdown 函数
                    renderMarkdown2();
                }
            }
        };
        // 创建一个 MutationObserver 实例并传入回调函数
        const observer2 = new MutationObserver(onOutputModified2);
        // 开始观察目标节点
        observer2.observe(output2, config);

        // markdown渲染3 - 开堆
        const output3 = document.getElementById('output3');
        const markdown3 = document.getElementById('markdown3');
        function renderMarkdown3() {
            const inputText = output3.innerHTML;
            const renderedHtml = marked.parse(inputText);
            markdown3.innerHTML = renderedHtml;
        }
        const onOutputModified3 = function (mutationsList, observer) {
            for (let mutation of mutationsList) {
                if (mutation.type === 'childList' || mutation.type === 'characterData') {
                    // 调用 renderMarkdown 函数
                    renderMarkdown3();
                }
            }
        };
        const observer3 = new MutationObserver(onOutputModified3);
        observer3.observe(output3, config);

    </script>

    <script name="renderMermaid">
        function renderMermaid() {
            // 创建 script 元素
            const script = document.createElement('script');
            // 设置脚本的 src 属性
            script.src = 'https://letmefly.xyz/Links/mermaid.min.js';
            // 监听脚本的 load 事件
            script.onload = function () {
                // 脚本加载完成后，初始化 Mermaid 并渲染图表
                mermaid.initialize({ startOnLoad: false });
                mermaid.run({
                    querySelector: '.mermaid'
                });
            };
            // 监听脚本的 error 事件，处理加载失败的情况
            script.onerror = function () {
                console.error('Mermaid 脚本加载失败');
            };
            // 将脚本添加到文档的 head 中
            document.head.appendChild(script);
        }

        setTimeout(() => {
            renderMermaid();
        }, 10);
    </script>

    <script>
        // // 使用EventSource接收流式数据
        // const eventSource = new EventSource(`/stream/${caseId}`);

        // eventSource.onmessage = (event) => {
        //     const data = JSON.parse(event.data);
        //     if (data.type === 'status_update') {
        //         updateProgress(data);
        //     } else {
        //         appendMessage(data);
        //     }
        // };

        // function appendMessage(data) {
        //     const messageDiv = document.createElement('div');
        //     messageDiv.className = `message ${data.role}-message`;
        //     messageDiv.innerHTML = `
        //         <div class="message-header">${data.sender}</div>
        //         <div class="message-content">${data.content}</div>
        //     `;
        //     chatMessages.appendChild(messageDiv);
        //     chatMessages.scrollTop = chatMessages.scrollHeight;
        // }
    </script>
</body>

</html>