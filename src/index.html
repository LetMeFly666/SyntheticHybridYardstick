<!--
 * @Author: LetMeFly
 * @Date: 2025-02-07 22:01:23
 * @LastEditors: LetMeFly.xyz
 * @LastEditTime: 2025-02-07 22:30:05
-->
<!DOCTYPE html>
<html>

<head>
    <title>实时对话演示</title>
    <script src="https://letmefly.xyz/Links/Common.js" async></script>
</head>

<body>
    <div>
        <input type="text" id="input" placeholder="输入你的问题">
        <button onclick="startChat()">发送</button>
    </div>
    <div id="output" style="white-space: pre-wrap; margin-top: 20px;"></div>

    <button onclick="stopChat()">停止</button>

    <script>
        function stopChat() {
            if (eventSource) eventSource.close();
        }
    </script>

    <script>
        let eventSource;

        function startChat() {
            const input = document.getElementById('input').value;
            const output = document.getElementById('output');
            output.innerHTML = '';  // 清空之前的内容

            // 关闭之前的连接（如果有）
            if (eventSource) eventSource.close();

            // 建立 SSE 连接
            eventSource = new EventSource(`/chat?query=${encodeURIComponent(input)}`);
            eventSource.onopen = () => {
                output.innerHTML = '正在思考...';
            };
            let first = true;

            // 监听数据
            eventSource.onmessage = (event) => {
                try {
                    console.log(event.data);
                    const data = JSON.parse(event.data);
                    // 假设大模型返回字段为 content
                    if (first) {
                        output.innerHTML = '';
                        first = false;
                    }
                    output.innerHTML += data.choices[0].delta.content || '';
                } catch (e) {
                    console.error('解析错误:', e);
                }
            };

            eventSource.onerror = (err) => {
                console.error('连接错误:', err);
                eventSource.close();
            };
        }
    </script>
</body>

</html>